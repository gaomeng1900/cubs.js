import{_ as A,j as f}from"./index-cf5c1735.js";import{S as H,a as I,R as U,s as X}from"./Test.module-3cb5013e.js";import{C as Y,c as q,b as O,l as F,t as J}from"./plots-41bb909b.js";import{d as K}from"./marker-595018be.js";async function N(p){const c=await fetch(p).then(l=>l.blob()),n=new Audio;n.src=URL.createObjectURL(c),n.crossOrigin="anonymous",n.preload="auto";const v=await new Promise(l=>{n.addEventListener("loadedmetadata",()=>{l(n.duration)})});return n.load(),await new Promise((l,h)=>{n.addEventListener("canplaythrough",()=>{l()}),n.addEventListener("error",()=>{h()})}),{audio:n,blob:c,duration:v}}async function $(p,c){const n=new AudioContext({sampleRate:c});return n.decodeAudioData(p).finally(()=>n.close())}const G="./test-audio.mp3",Q="https://freesound.org/people/quetzalcontla/sounds/612846/";function se(){const p=A.useRef(null),c=800,n=250,v=150,l=740,h=20;return A.useEffect(()=>{const P=p.current,o=new H(P),t=new Y;return t.viewportX=30,t.viewportY=50,t.viewportWidth=l,t.viewportHeight=v,o.add(t.indicator),q(o,t,{lockY:!0,lockScale:!1,xStartMin:0,xEndMax:100}),(async()=>{const{blob:_,audio:d,duration:m}=await N(G);console.log(d),o.addEventListener("dispose",()=>{d.pause()});const W=await _.arrayBuffer(),x=(await $(W,3e3)).getChannelData(0),C=x.length,T=x.reduce((e,s)=>Math.max(Math.abs(s),e),0),a=100,u=100;let g=1*.5*u;g=1/T*.5*u;const E=4e3,L=[];if(E<x.length)for(let e=0;e<E;e++){const s=e/E,i=Math.round(s*C);L.push({x:s*a,y:x[i]*g+.5*u})}else for(let e=0;e<x.length;e++)L.push({x:e/C*a,y:x[e]*g+.5*u});const k=O(t,[{x:a/2,y:u}],{barWidth:a,color:"#ffbab7"}),S=Array.from(k.children.values())[0];S.style.pointerEvents="none",S.style.stroke=!0,S.style.strokeStyle="rgba(0, 0, 0, 0.5)",o.add(k);const R=F(t,L),b=R.userData.polyline;b.style.lineWidth=1,b.style.lineJoin="miter",b.style.strokeStyle="#0c5ef9",b.style.pointerEvents="none",o.add(R);const z=J(t,{disableY:!0,xColor:"#000000",xToString:e=>`${(e/100*m).toFixed(1)}s`});o.add(z);let w=!1;{const e=new I,s=t.project(0,u);e.x=s[0],e.y=s[1]-h,e.dy=v+h,e.style.zIndex=10,e.dx=0,e.style.lineWidth=3,e.style.pointerEvents="none",e.style.strokeStyle="rgba(255, 0, 0, 0.8)",o.add(e),t.addEventListener("update",i=>{const y=d.currentTime,j=Math.min(1,y/m)*a;e.x=t.project(j,0)[0]}),o.addEventListener("beforeRender",()=>{const i=d.currentTime,y=Math.min(1,i/m)*a;e.x=t.project(y,0)[0]})}const r=new U;r.hoverStyle.cursor="ew-resize";const D=()=>{const e=t.project(0,0)[0],[s,i]=t.project(a,u);r.x=e,r.y=i-h,r.width=s-e,r.height=h};D(),t.addEventListener("update",D),o.add(r),r.style.fillStyle="#b973ee",r.addEventListener("pointerdown",e=>{if(e.srcEvent.button!==0)return;w=!1,d.pause();const s=y=>{const j=y.srcEvent.offsetX,B=t.unproject(j,0)[0]/a*m;d.currentTime=B};s(e),r.addEventListener("pointermove",s);const i=y=>{r.removeEventListener("pointermove",s),r.removeEventListener("pointerup",i)};r.addEventListener("pointerup",i)});const M=e=>{e.code==="Space"&&(w?(w=!1,d.pause()):(w=!0,d.play()))};o.disposed||(document.addEventListener("keydown",M),o.addEventListener("dispose",()=>{document.removeEventListener("keydown",M)})),K(o,t,{draggable:!0,min:0,max:a})})(),()=>{o.dispose()}},[]),f.jsxs("div",{className:X.wrapper,children:[f.jsx("canvas",{ref:p,width:c,height:n,style:{width:c,height:n,border:"rgb(255, 255, 255) 3px solid",boxShadow:"#00000076 0 0 10px 1px"}}),f.jsx("div",{children:"💡 使用空格键控制播放与暂停"}),f.jsx("div",{children:f.jsx("a",{href:Q,target:"_blank",rel:"noreferrer",children:"🔗 测试音频协议 (Attribution 4.0), 作者 @quetzalcontla"})})]})}export{se as default};
